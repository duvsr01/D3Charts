<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      padding-top: 25px;
      margin: auto;
      width: 650px;
      font: 18px arial;
    }
  </style>
</head>

<body>
  <b>Covid-19 Cases</b><br />
  <svg id="chart" width="650" height="420"></svg>

  Choose Month:
  <select id="month"></select>

  <script>
    d3.csv("https://duvsr01.github.io/D3Charts/sampledata.csv").then((d) =>
      chart(d)
    );

    function chart(csv) {
      csv.forEach(function (d) {
        return d;
      });

      var months = [...new Set(csv.map((d) => d.Month))],
        countries = [...new Set(csv.map((d) => d.Country))];

      console.log("months and countries" + months, countries);

      var tempColor;
      var options = d3
        .select("#month")
        .selectAll("option")
        .data(months)
        .enter()
        .append("option")
        .text((d) => d);

      console.log("options is" + JSON.stringify(options));

      var svg = d3.select("#chart"),
        margin = { top: 25, bottom: 10, left: 25, right: 25 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

      var x = d3
        .scaleBand()
        .range([margin.left, width - margin.right])
        .padding(0.1)
        .paddingOuter(0.2);

      var y = d3.scaleLinear().range([height - margin.bottom, margin.top]);

      var tooltip = d3
        .select("#chart")
        .append("div")
        .style("position", "absolute")
        .style("padding", "0 10px")
        .style("background", "white")
        .style("opacity", 0)
        .text("here is tooltip");

      var xAxis = (g) =>
        g
          .attr("transform", "translate(0," + (height - margin.bottom) + ")")
          .call(d3.axisBottom(x).tickSizeOuter(0));

      var yAxis = (g) =>
        g
          .attr("transform", "translate(" + margin.left + ",0)")
          .call(d3.axisLeft(y));

      svg.append("g").attr("class", "x-axis");

      svg.append("g").attr("class", "y-axis");

      d3.selectAll("rect.bar").on("mouseover", function () {
        return tooltip;
      });

      update(d3.select("#month").property("value"), 0);

      function update(month, speed) {
        console.log("month is" + month);
        var data = csv.filter((f) => f.Month == month);

        console.log("the data values here are" + JSON.stringify(data));

        var maxVal = d3.max(data, function (d) {
          return d.Cases;
        });
        console.log("maxval is" + maxVal);

        //y.domain([0, maxVal]);
        y.domain([
          0,
          d3.max(data, function (d) {
            return d.Cases;
          }),
        ]);

        svg.selectAll(".y-axis").transition().duration(speed).call(yAxis);

        /* data.sort(
          d3.select("#sort").property("checked")
            ? (a, b) => b.Cases - a.Cases
            : (a, b) => Month.indexOf(a.Month) - Month.indexOf(b.Month)
        ); */

        x.domain(data.map((d) => d.Country));

        svg.selectAll(".x-axis").transition().duration(speed).call(xAxis);

        var bar = svg.selectAll(".bar").data(data, (d) => d.Country);

        bar.exit().remove();

        bar
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("fill", "steelblue")
          .attr("width", x.bandwidth())
          .merge(bar)
          .transition()
          .duration(speed)
          .attr("x", (d) => x(d.Country))
          .attr("y", (d) => y(d.Cases))
          .attr("height", (d) => y(0) - y(d.Cases));
      }

      chart.update = update;
    }

    var select = d3
      .select("#month")
      .style("border-radius", "5px")
      .on("change", function () {
        chart.update(this.value, 750);
      });
  </script>
</body>
